<!-- $theme: gaia -->

# Web開発における
# セキュリティ基礎講座

## 2017/11/14

---

# お題

- 情報セキュリティとは
- リスクアセスメントとは
- Webアプリの脅威と脆弱性
  - 様々な脅威・脆弱性とその対策の紹介
- 脆弱性の埋め込みを防ぐために
  - 開発における注意事項
  - 読んでおくべき情報

---

# 情報セキュリティとは？

---

# 情報セキュリティとは

- 機密性（Confidentiality）
  - 正当な権利者だけが利用できる状態
- 完全性（Integrity）
  - 正当な権利者以外は変更できない状態
- 可用性（Availability）
  - 必要なときに利用できる状態

これらが維持されている状態を保つこと
→ **情報セキュリティのCIA**

---

# ちゃんと
# リスクアセスメント
# しましょう

---

# リスクアセスメントとは

**リスク = 影響度 × 発生確率**

- 影響度
  - 情報資産に与える影響範囲や損害金額等
- 発生確率
  - 脆弱性と脅威

情報資産を守るには、
**リスクを適切に算出し評価・対策すること**
が大事

---

# Webアプリにおける
# 脅威と脆弱性を知ろう

---

# Webアプリの脅威・脆弱性

- クロスサイト・スクリプティング（XSS）
- SQLインジェクション
- OSコマンドインジェクション
- ディレクトリ・トラバーサル
- クロスサイト・リクエスト・フォージェリ（CSRF）
- セッション・ハイジャック
  - セッション・フィクセーション

---
<!-- *template: invert -->

# XSS

被害件数が最も多い脆弱性
閲覧者のブラウザ上で任意のスクリプトが実行される

ユーザ入力の内容を表示する場合に危険

```php
echo '内容確認：'.$_GET['message'];
```

- 情報漏洩、ユーザのデータ改竄
- フィッシング詐欺
- 他の攻撃への踏み台

最新のChromeではある程度防御される

---

# XSS 対策

- ユーザの入力をそのまま表示しない
  - `htmlspecialchars` 等でサニタイズを行う
  - 一部のタグだけ許可する方法もある
- Content-Type をきちんと指定する
  - 文字コードの自動認識に頼ると危険
  - UTF-8 がデファクトスタンダード

---
<!-- *template: invert -->

# SQLインジェクション

被害件数が多い、メジャーな脆弱性

ユーザ入力を元にSQLを構築する場合に危険

```php
$pdo->query('SELECT * FROM users WHERE id='.$_GET['id']);
```

- 情報漏洩
- データの改竄、消去
- システムダウン

---

# SQLインジェクション対策

- 入力のバリデーションを行う
- SQLにはプレースホルダを使う
  - 自力でエスケープをしない、バグのもと
  - 用意されている仕組みを使う
- システムのエラーメッセージを画面に出さない
  - ログに出力する
- DBアカウントの権限を適切に設定する
  - create table や grant 等は通常は不要

---
<!-- *template: invert -->

# OSコマンドインジェクション

SQLインジェクションのコマンド版

ユーザ入力を元に内部でコマンド実行する場合に危険

perl の open 関数、PHP の system 関数等

```php
system('/usr/lib/sendmail '.$_GET['to']);
```

- 情報漏漏洩、ファイルやデータの改竄・削除
- ウィルス・ボット感染、バックドア設置
- システムダウン

---

# OSコマンドインジェクション対策

- 入力のバリデーションを行う
- パラメータのエスケープを行う
  - `escapeshellarg` 等
  - `escapeshellcmd` は不備があるので不可
- そもそもの設計を見直す
  - 外部コマンドを実行する以外にないか？

---
<!-- *template: invert -->

# ディレクトリ・トラバーサル

本来アクセス出来ないはずのファイルにアクセス可能になる

ユーザ入力を元にファイルアクセスする場合に危険

```php
fopen('/var/tmp/'.$_GET['filename'], 'r');
```

- 情報漏洩
- ファイルやデータの改竄・削除

---

# ディレクトリ・トラバーサル対策

- パスからディレクトリ部分を取り除く
- アクセス権限を厳密にする
  - ファイルのowner、プログラムのowner
  - SELinux をきちんと使う
- そもそも設計を見直す
  - ユーザ入力でファイルを開く必要があるか？

---

<!-- *template: invert -->

# CSRF

ユーザの意図しないリクエストを偽造して送信させる

裏で通信が行われることが多いため、閲覧しているユーザは気づかないことが多い

- 意図しない投稿（爆破予告等、自分が攻撃者になる）
- 意図しない購入や送金

---

# CSRF対策

- 重要な変更を伴う場合はhiddenでワンタイムの秘密情報を埋め込む
  - CSRFでリクエストを送ろうにも推測できない
- 処理前に再度パスワード入力を求める

---
<!-- *template: invert -->

# セッション・フィクセーション

意図的にセッションIDを固定化させ、アクセスしたユーザの情報を盗む・なりすます

XSS等の攻撃と組み合わせて攻撃を行う事が多い

- 利用者の情報漏洩
- 利用者のみがアクセスできる情報の改竄・削除

---

# セッション・フィクセーション対策

- URLにセッションIDを含めない
- cookieにsecure、httpOnly属性をつける
- アクセス時に新規のセッションIDを払い出す
  - `session_regenerate_id` の利用等
  - 固定化に使ったセッションIDは捨てられる

---

# 脆弱性の埋め込みを
# 防ぐために

---

# 開発における注意事項(1)

- ユーザの入力は信用しない
  - 必ずバリデーション・サニタイズを行う
- 言語やフレームワーク等に用意されている機能を積極的に活用する
  - よくある内容は対策の仕組みも用意されている
  - 自前実装は極力行わない

---

# 開発における注意事項(2)

- アンテナを常に張っておく
  - セキュリティ情報
    - どんな脆弱性があるのか
      - JPCERT 等
  - バグフィックス情報
    - 脆弱性への対策がされているかどうか
    - 必要なバージョンアップを適切に行う

---

# 読んでおくべき情報

- IPA 情報セキュリティ対策
  - https://www.ipa.go.jp/security/vuln/websecurity.html

- 体系的に学ぶ-安全なWebアプリケーションの作り方
  - https://www.amazon.co.jp/dp/4797361190
